#include <Wire.h>
#include <SPI.h>
#include <Adafruit_I2CDevice.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <Keypad.h>

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// Define keypad layout
const byte ROWS = 4;
const byte COLS = 4;
char keys[ROWS][COLS] = {
{'1','2','3','A'},
{'4','5','6','B'},
{'7','8','9','C'},
{'*','0','#','D'}
};

// Change these to match your wiring
byte rowPins[ROWS] = {9, 8, 7, 6}; /* connect to the row pinouts of the keypad */
byte colPins[COLS] = {5, 4, 3, 2}; /* connect to the column pinouts of the keypad */

Keypad keypad = Keypad(makeKeymap(keys), rowPins, colPins, ROWS, COLS);

String input = "";
bool showCursor = true;
unsigned long lastBlink = 0;

void setup() {
display.begin(SSD1306_SWITCHCAPVCC, 0x3C);
display.clearDisplay();
display.setTextSize(2);
display.setTextColor(SSD1306_WHITE);
loadingAnimation();
displayMessage("Ready");
}

void loop() {
char key = keypad.getKey();
if (key) handleKey(key);
blinkCursor();
}

// Show a small loading animation
void loadingAnimation() {
display.clearDisplay();
display.setCursor(0, 10);
display.print("Loading");
for (int i = 0; i < 3; i++) {
display.print(".");
display.display();
delay(400);
}
delay(500);
display.clearDisplay();
display.display();
}

// Handle keypad input
void handleKey(char key) {
if (key == '*') { // Clear
input = "";
displayMessage("Cleared");
} else if (key == '#') { // Evaluate
float result = evaluate(input);
displayResult(result);
input = "";
} else {
if (key == 'A') key = '+';
else if (key == 'B') key = '-';
else if (key == 'C') key = '*';
else if (key == 'D') key = '/';
input += key;
displayMessage(input);
}
}

// Evaluate basic math
float evaluate(String expr) {
int opIndex = -1;
char op;
for (int i = 0; i < expr.length(); i++) {
if (expr[i] == '+' || expr[i] == '-' || expr[i] == '*' || expr[i] ==
'/') {
opIndex = i;
op = expr[i];
break;
}
}
if (opIndex == -1) return 0;

float a = expr.substring(0, opIndex).toFloat();
float b = expr.substring(opIndex + 1).toFloat();

switch (op) {
case '+': return a + b;
case '-': return a - b;
case '*': return a * b;
case '/': return (b != 0) ? a / b : 0;
}
return 0;
}

// Display messages
void displayMessage(String msg) {
display.clearDisplay();
display.setCursor(0, 10);
display.print(msg);
// --- Watermark Addition ---
const char* watermark = "Your Name";
display.setTextSize(1); // Small text size for watermark
int16_t x1, y1;
uint16_t w, h;
display.getTextBounds(watermark, 0, 0, &x1, &y1, &w, &h);
// Calculate position for bottom-right corner (adjust by 1 pixel for padding)
display.setCursor(SCREEN_WIDTH - w - 1, SCREEN_HEIGHT - h - 1);
display.print(watermark);
// Restore original settings for main message/input
display.setTextSize(2);
// --- End Watermark Addition ---
display.display();
}

// Show result
void displayResult(float result) {
display.clearDisplay();
display.setTextSize(1);
display.setCursor(0, 10);
display.print("Result:");
display.setTextSize(2);
display.setCursor(0, 30);
display.print(result);
display.display();
delay(2000);
display.setTextSize(2);
displayMessage("Ready");
}

// Blinking cursor
void blinkCursor() {
if (millis() - lastBlink > 500) {
lastBlink = millis();
showCursor = !showCursor;
if (showCursor) {
display.setCursor(display.getCursorX(), display.getCursorY());
display.print("_");
display.display();
} else {
displayMessage(input);
}
}
}
